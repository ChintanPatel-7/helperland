
@{
    ViewData["Title"] = "Service Requests";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="d-flex">
    <h2 class="page-title mt-auto mb-auto">Service Requests</h2>
</div>
<div class="user-search-box">

    <input type="text" class="form-control input-element width-110" id="" placeholder="Service Id">

    <select class="form-select input-element width-127" aria-label="User name">
        <option value="" disabled selected hidden>Customer</option>
        <option value="1">One</option>
        <option value="2">Two</option>
        <option value="3">Three</option>
    </select>

    <select class="form-select input-element width-152" aria-label="User role">
        <option value="" disabled selected hidden>Service Provider</option>
        <option value="1">One</option>
        <option value="2">Two</option>
        <option value="3">Three</option>
    </select>

    <select class="form-select input-element width-120" aria-label="User role">
        <option value="" disabled selected hidden>Status</option>
        <option value="1">One</option>
        <option value="2">Two</option>
        <option value="3">Three</option>
    </select>

    <input type="text" id="txtFromDate" placeholder="From Date" onfocus="(this.type='date')" class="calender-icon form-control input-element width-135">
    <!-- <input type="date" class="form-control input-element width-135" id=""> -->

    <input type="text" id="txtToDate" placeholder="To Date" class="calender-icon form-control input-element width-135" onfocus="(this.type='date')">
    <!-- <input type="date" class="form-control input-element width-135" id=""> -->

    <button class="btn btn-Search width-84">Search</button>

    <button class="btn width-84 btn-clear" type="reset">Clear</button>

</div>

<div class="data-table">
    <table id="tblServiceRequests">
        <thead>
            <tr>
                <th>Service ID<img class="sort-img" alt=""></th>
                <th>Service Date<img class="sort-img" alt=""></th>
                <th>Customer details<img class="sort-img" alt=""></th>
                <th>Service provider<img class="sort-img" alt=""></th>
                <th>Status<img class="sort-img" alt=""></th>
                <th>Actions</th>
            </tr>
        </thead>
    </table>
</div>

@section Scripts{
    <script type="text/javascript">

        $(document).ready(function () {
            $('#tblServiceRequests').on('draw.dt', function () { //every time ajax call, this code execute
                $(".spRating").rating({
                    min: 0,
                    max: 5,
                    step: 0.1,
                    size: "xs",
                    stars: "5",
                    showClear: false,
                    readonly: true,
                    starCaptions: function (val) {
                        return val;
                    },
                    starCaptionClasses: function () {
                        return "fs-16";
                    },
                });
            });

            $('#tblServiceRequests').DataTable({
                paging: true,
                processing: true,
                serverSide: true,
                filter: true,
                ordering: true,
                searching: false,
                info: true,
                ajax: {
                    url: "/Admin/GetServiceRequestList",
                    type: "POST",
                    datatype: "json",
                    dataSrc: 'data',
                    "data": function (d) {
                        //d.searchUserName = $("#UserName").val();
                        //d.searchUserType = $("#UserType").val();
                        //d.searchPhoneNumber = $("#PhoneNumber").val();
                        //d.searchZipcode = $("#Zipcode").val();
                        //d.searchRegistrationStartDate = $("#txtFromDate").val();
                        //d.searchRegistrationEndDate = $("#txtToDate").val();
                    }
                },
                oLanguage: {
                    sInfo: "Total Records: _TOTAL_",
                    sProcessing: "<div id='preloader'><div id='loader'></div></div>"
                },
                "columnDefs": [
                    { "orderable": false, "targets": 5 }
                ],
                columns: [
                    {
                        data: 'serviceRequestId',
                        name: 'ServiceRequestId',
                    },
                    {
                        name: 'ServiceStartDate',
                        render: function (data, type, row) {
                            //console.log(row)
                            return "<img src='../img/admin-panel/calendar2.png' alt='calender' class='me-1'><span> " +
                                DateFormatDDMMYYYY(row.serviceStartDate) + "</span><br/>" +
                                "<img src='../img/admin-panel/layer-14.png' alt='clock' class='me-1'> " + 
                                ServiceTime(row.serviceStartDate, 0) + " - " + ServiceTime(row.serviceStartDate, row.serviceHours);
                        }
                    },
                    {
                        name: 'Customer',
                        render: function (data, type, row) {
                            return "<div class='align-items-center d-flex'><img src='../img/admin-panel/layer-15.png' class='me-2'><div>" +
                                row.user.firstName + " " + row.user.lastName + "<br>" + row.serviceRequestAddresses[0].addressLine1 + " " +
                                row.serviceRequestAddresses[0].addressLine2 + "<br>" + row.serviceRequestAddresses[0].postalCode + " " +
                                row.serviceRequestAddresses[0].city + "</div></div>";
                        }
                    },
                    {
                        name: 'ServiceProvider',
                        render: function (data, type, row) {
                            //if (row.serviceProvider == null) {
                            //    return "";
                            //}
                            //else {
                            //    var totalRating = 0;
                            //    var spRating = 0;
                            //    var count = 0;

                            //    row.ratings.forEach(function (element) {
                            //        totalRating = totalRating + element.ratings;
                            //        count = count + 1;
                            //    });


                            //    if (count == 0) {
                            //        return "<div><img src='" + row.serviceProvider.userProfilePicture + "' class='cap-img float-start' alt='cap image'> " +
                            //            "<div class='name-rating'> <label>" + row.serviceProvider.firstName + " " + row.serviceProvider.lastName + "</label> <div> " + "Not Rated";
                            //    }

                            //    spRating = (totalRating / count);

                            //    var spRatingRounded = Math.round(spRating * 10) / 10;

                            //    return "<div><img src='" + row.serviceProvider.userProfilePicture + "' class='cap-img float-start' alt='cap image'> " +
                            //        "<div class='name-rating'> <label>" + row.serviceProvider.firstName + " " + row.serviceProvider.lastName + "</label> <div> " +
                            //        "<input id='sprating_" + row.serviceProvider.userId + "_" + row.serviceRequestId + "' class='spRating' value='" + spRatingRounded + "' type='text' title='' hidden>";
                            //}
                            return "";
                        }
                    },
                    {
                        name: 'Status',
                        render: function (data, type, row) {
                            var htmlContent = "";

                            switch (row.status) {
                                case 1: htmlContent = htmlContent + "<label class='lbl-btn lbl-yellow'>New</label>";
                                    break;
                                case 2: htmlContent = htmlContent + "<label class='lbl-btn lbl-lightBlue'>Pending</label>";
                                    break;
                                case 3: htmlContent = htmlContent + "<label class='lbl-btn lbl-danger'>Cancelled</label>";
                                    break;
                                case 4: htmlContent = htmlContent + "<label class='lbl-btn lbl-success'>Completed</label>";
                                    break;
                            }
                            return htmlContent;
                        }
                    },
                    {
                        render: function (data, type, row) {
                            return "<div class='dropdown'><button class='btn dropdown-toggle' type='button' id='dropdownMenuButton1' " +
                                " data-bs-toggle='dropdown' aria-expanded='false'><img src='../img/admin-panel/group-38.png' alt='dots' " +
                                " class='position-relative'></button><ul class='dropdown-menu' aria-labelledby='dropdownMenuButton1'>" +
                                    "<li><a class='dropdown-item' >Edit & Reschedule</a></li>" + 
                                    "<li><a class='dropdown-item' >Refund</a></li>" +
                                    "<li><a class='dropdown-item' >Cancel</a></li>" +
                                    "<li><a class='dropdown-item' >Change SP</a></li>" + 
                                    "<li><a class='dropdown-item' >Escalate</a></li>" +
                                    "<li><a class='dropdown-item' >History Log</a></li>" +
                                    "<li><a class='dropdown-item' >Download Invoice</a></li></ul></div >";
                        }
                    },
                ],
                dom: '<"top">rt<"bottom"lip><"clear">',
                responsive: true,
                order: [[0, "desc"]]
            });

            $("#txtFromDate").change(function () {
                $("#txtToDate").attr("min", $("#txtFromDate").val());
            });

            $("#txtToDate").change(function () {
                $("#txtFromDate").attr("max", $("#txtToDate").val());
            });

        });

        function SearchUser() {
            $('#tblUserManagement').DataTable().ajax.reload();
        }

        function ResetSearchData() {
            $("#UserName").val("");
            $("#UserType").val("");
            $("#PhoneNumber").val("");
            $("#Zipcode").val("");
            $("#txtFromDate").val("");
            $("#txtToDate").val("");
            $('#tblUserManagement').DataTable().ajax.reload();
        }

    </script>
}

